{
    "info": {
        "_postman_id": "vectra-api-collection-phase3",
        "name": "Vectra API Collection - Phase 3",
        "description": "Collection complète pour tester les APIs Vectra Phase 3 - Architecture Multi-Tenant & Notifications",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
        "_exporter_id": "vectra-api-phase3"
    },
    "item": [
        {
            "name": "Auth",
            "item": [
                {
                    "name": "Register",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "if (pm.response.code === 201) {",
                                    "    const response = pm.response.json();",
                                    "    pm.environment.set(\"access_token\", response.access_token);",
                                    "    pm.environment.set(\"refresh_token\", response.refresh_token);",
                                    "    pm.environment.set(\"user_id\", response.user.id);",
                                    "    if (response.user.organization) {",
                                    "        pm.environment.set(\"organization_id\", response.user.organization.id);",
                                    "    }",
                                    "    ",
                                    "    pm.test(\"Status code is 201\", function () {",
                                    "        pm.response.to.have.status(201);",
                                    "    });",
                                    "    ",
                                    "    pm.test(\"Response has access_token\", function () {",
                                    "        pm.expect(response).to.have.property(\"access_token\");",
                                    "    });",
                                    "    ",
                                    "    pm.test(\"Response has user object\", function () {",
                                    "        pm.expect(response).to.have.property(\"user\");",
                                    "        pm.expect(response.user).to.have.property(\"email\");",
                                    "    });",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [{"key": "Content-Type", "value": "application/json"}],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"{{test_email}}\",\n    \"password\": \"password123\",\n    \"first_name\": \"Test\",\n    \"last_name\": \"User\",\n    \"organization_name\": \"Test Organization\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/auth/register",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "auth", "register"]
                        },
                        "description": "Register a new user with a new organization. If email matches PLATFORM_ADMIN_EMAIL, creates platform admin without organization."
                    },
                    "response": []
                },
                {
                    "name": "Login",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "if (pm.response.code === 200) {",
                                    "    const response = pm.response.json();",
                                    "    pm.environment.set(\"access_token\", response.access_token);",
                                    "    pm.environment.set(\"refresh_token\", response.refresh_token);",
                                    "    pm.environment.set(\"user_id\", response.user.id);",
                                    "    if (response.user.organization) {",
                                    "        pm.environment.set(\"organization_id\", response.user.organization.id);",
                                    "    }",
                                    "    pm.test(\"Status code is 200\", function () {",
                                    "        pm.response.to.have.status(200);",
                                    "    });",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "urlencoded",
                            "urlencoded": [
                                {"key": "username", "value": "{{test_email}}", "type": "text"},
                                {"key": "password", "value": "password123", "type": "text"}
                            ]
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/auth/login",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "auth", "login"]
                        }
                    },
                    "response": []
                },
                {
                    "name": "Refresh Token",
                    "request": {
                        "method": "POST",
                        "header": [{"key": "Content-Type", "value": "application/json"}],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"refresh_token\": \"{{refresh_token}}\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/auth/refresh",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "auth", "refresh"]
                        }
                    },
                    "response": []
                },
                {
                    "name": "Change Password",
                    "request": {
                        "method": "POST",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"current_password\": \"password123\",\n    \"new_password\": \"newpassword456\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/auth/change-password",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "auth", "change-password"]
                        }
                    },
                    "response": []
                },
                {
                    "name": "Logout",
                    "request": {
                        "method": "POST",
                        "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/auth/logout",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "auth", "logout"]
                        }
                    },
                    "response": []
                }
            ],
            "description": "Endpoints d'authentification JWT"
        },
        {
            "name": "User",
            "item": [
                {
                    "name": "Get Current User (Me)",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/me",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "me"]
                        },
                        "description": "Get current authenticated user profile."
                    },
                    "response": []
                },
                {
                    "name": "Get My Organization",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/organizations/me",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "organizations", "me"]
                        },
                        "description": "Get current user's organization (Owner/Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Update My Organization",
                    "request": {
                        "method": "PATCH",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"name\": \"Updated Organization Name\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/organizations/me",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "organizations", "me"]
                        },
                        "description": "Update current user's organization (Owner/Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "List Organization Users",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/organizations/me/users",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "organizations", "me", "users"]
                        },
                        "description": "List users in current organization (Owner/Admin/Manager only)."
                    },
                    "response": []
                },
                {
                    "name": "Invite User",
                    "request": {
                        "method": "POST",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"invited@example.com\",\n    \"role\": \"operator\",\n    \"first_name\": \"Invited\",\n    \"last_name\": \"User\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/organizations/me/users/invite",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "organizations", "me", "users", "invite"]
                        },
                        "description": "Invite a user to join organization (Owner/Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Update User Role",
                    "request": {
                        "method": "PATCH",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"role\": \"admin\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/organizations/me/users/{{target_user_id}}/role",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "organizations", "me", "users", "{{target_user_id}}", "role"]
                        },
                        "description": "Update user role in organization (Owner/Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Remove User",
                    "request": {
                        "method": "DELETE",
                        "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/organizations/me/users/{{target_user_id}}",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "organizations", "me", "users", "{{target_user_id}}"]
                        },
                        "description": "Remove user from organization (Owner/Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Send Notification (Org to Prospects)",
                    "request": {
                        "method": "POST",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"type\": \"org_to_prospects\",\n    \"recipients\": [\"prospect1@example.com\", \"prospect2@example.com\"],\n    \"subject\": \"Test Notification\",\n    \"body\": \"Test body\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/user/notifications/send",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "user", "notifications", "send"]
                        },
                        "description": "Send notification to prospects (Owner/Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Leads",
                    "item": [
                        {
                            "name": "List Leads",
                            "request": {
                                "method": "GET",
                                "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/leads?campaign_id={{campaign_id}}&status=qualified&bant_score_min=60&skip=0&limit=100",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "leads"],
                                    "query": [
                                        {"key": "campaign_id", "value": "{{campaign_id}}", "disabled": true},
                                        {"key": "status", "value": "qualified", "disabled": true},
                                        {"key": "bant_score_min", "value": "60", "disabled": true},
                                        {"key": "skip", "value": "0", "disabled": true},
                                        {"key": "limit", "value": "100", "disabled": true}
                                    ]
                                },
                                "description": "List leads with optional filters (campaign_id, status, intent, bant_score, search, dates)."
                            },
                            "response": []
                        },
                        {
                            "name": "Get Lead",
                            "request": {
                                "method": "GET",
                                "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/leads/{{lead_id}}",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "leads", "{{lead_id}}"]
                                },
                                "description": "Get lead details with interactions, emails, and meetings."
                            },
                            "response": []
                        },
                        {
                            "name": "Get Lead Interactions",
                            "request": {
                                "method": "GET",
                                "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/leads/{{lead_id}}/interactions?skip=0&limit=100",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "leads", "{{lead_id}}", "interactions"],
                                    "query": [
                                        {"key": "skip", "value": "0", "disabled": true},
                                        {"key": "limit", "value": "100", "disabled": true}
                                    ]
                                },
                                "description": "Get lead interaction history (emails, meetings, agent runs)."
                            },
                            "response": []
                        },
                        {
                            "name": "Update Lead",
                            "request": {
                                "method": "PATCH",
                                "header": [
                                    {"key": "Authorization", "value": "Bearer {{access_token}}"},
                                    {"key": "Content-Type", "value": "application/json"}
                                ],
                                "body": {
                                    "mode": "raw",
                                    "raw": "{\n    \"first_name\": \"Updated\",\n    \"last_name\": \"Name\",\n    \"phone\": \"+33612345678\",\n    \"status\": \"qualified\",\n    \"notes\": \"Updated notes\"\n}"
                                },
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/leads/{{lead_id}}",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "leads", "{{lead_id}}"]
                                },
                                "description": "Update lead manually (first_name, last_name, phone, status, notes)."
                            },
                            "response": []
                        }
                    ],
                    "description": "Endpoints pour gérer les leads"
                },
                {
                    "name": "Emails",
                    "item": [
                        {
                            "name": "List Emails",
                            "request": {
                                "method": "GET",
                                "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/emails?campaign_id={{campaign_id}}&status=pending&skip=0&limit=100",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "emails"],
                                    "query": [
                                        {"key": "campaign_id", "value": "{{campaign_id}}", "disabled": true},
                                        {"key": "lead_id", "value": "{{lead_id}}", "disabled": true},
                                        {"key": "status", "value": "pending", "disabled": true},
                                        {"key": "skip", "value": "0", "disabled": true},
                                        {"key": "limit", "value": "100", "disabled": true}
                                    ]
                                },
                                "description": "List emails with optional filters (campaign_id, lead_id, status)."
                            },
                            "response": []
                        },
                        {
                            "name": "Get Email",
                            "request": {
                                "method": "GET",
                                "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/emails/{{email_id}}",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "emails", "{{email_id}}"]
                                },
                                "description": "Get email details with tracking information."
                            },
                            "response": []
                        },
                        {
                            "name": "Approve Email",
                            "event": [
                                {
                                    "listen": "test",
                                    "script": {
                                        "exec": [
                                            "pm.test(\"Status code is 200\", function () {",
                                            "    pm.response.to.have.status(200);",
                                            "});",
                                            "pm.test(\"Email status is approved\", function () {",
                                            "    const response = pm.response.json();",
                                            "    pm.expect(response.data.status).to.eql(\"approved\");",
                                            "});"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "request": {
                                "method": "POST",
                                "header": [
                                    {"key": "Authorization", "value": "Bearer {{access_token}}"},
                                    {"key": "Content-Type", "value": "application/json"}
                                ],
                                "body": {
                                    "mode": "raw",
                                    "raw": "{\n    \"modifications\": {\n        \"subject\": \"Updated Subject (optional)\",\n        \"body_html\": \"<p>Updated body (optional)</p>\"\n    }\n}"
                                },
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/emails/{{email_id}}/approve",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "emails", "{{email_id}}", "approve"]
                                },
                                "description": "Approve email for sending. Optionally modify subject or body."
                            },
                            "response": []
                        },
                        {
                            "name": "Reject Email",
                            "event": [
                                {
                                    "listen": "test",
                                    "script": {
                                        "exec": [
                                            "pm.test(\"Status code is 200\", function () {",
                                            "    pm.response.to.have.status(200);",
                                            "});",
                                            "pm.test(\"Email status is rejected\", function () {",
                                            "    const response = pm.response.json();",
                                            "    pm.expect(response.data.status).to.eql(\"rejected\");",
                                            "});"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "request": {
                                "method": "POST",
                                "header": [
                                    {"key": "Authorization", "value": "Bearer {{access_token}}"},
                                    {"key": "Content-Type", "value": "application/json"}
                                ],
                                "body": {
                                    "mode": "raw",
                                    "raw": "{\n    \"reason\": \"Email not suitable for this campaign\"\n}"
                                },
                                "url": {
                                    "raw": "{{base_url}}/api/v1/user/emails/{{email_id}}/reject",
                                    "host": ["{{base_url}}"],
                                    "path": ["api", "v1", "user", "emails", "{{email_id}}", "reject"]
                                },
                                "description": "Reject email with reason."
                            },
                            "response": []
                        }
                    ],
                    "description": "Endpoints pour gérer les emails"
                }
            ],
            "description": "Endpoints pour les utilisateurs d'organisation"
        },
        {
            "name": "Platform Admin",
            "item": [
                {
                    "name": "Get Platform Overview",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{admin_access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/overview",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "overview"]
                        },
                        "description": "Get platform overview statistics (Platform Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "List All Organizations",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{admin_access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/organizations",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "organizations"]
                        },
                        "description": "List all organizations (Platform Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Get Organization",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{admin_access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/organizations/{{organization_id}}",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "organizations", "{{organization_id}}"]
                        },
                        "description": "Get organization details (Platform Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Create Organization",
                    "request": {
                        "method": "POST",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{admin_access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"name\": \"New Organization\",\n    \"plan\": \"trial\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/organizations",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "organizations"]
                        },
                        "description": "Create a new organization (Platform Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Update Organization",
                    "request": {
                        "method": "PATCH",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{admin_access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"name\": \"Updated Organization Name\",\n    \"plan\": \"starter\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/organizations/{{organization_id}}",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "organizations", "{{organization_id}}"]
                        },
                        "description": "Update organization (Platform Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Delete Organization",
                    "request": {
                        "method": "DELETE",
                        "header": [{"key": "Authorization", "value": "Bearer {{admin_access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/organizations/{{organization_id}}",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "organizations", "{{organization_id}}"]
                        },
                        "description": "Delete organization (Platform Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "List All Users",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{admin_access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/users",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "users"]
                        },
                        "description": "List all users (Platform Admin only, excludes platform admins)."
                    },
                    "response": []
                },
                {
                    "name": "Get System Metrics",
                    "request": {
                        "method": "GET",
                        "header": [{"key": "Authorization", "value": "Bearer {{admin_access_token}}"}],
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/system/metrics",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "system", "metrics"]
                        },
                        "description": "Get system metrics (Platform Admin only)."
                    },
                    "response": []
                },
                {
                    "name": "Send Notification (Vectra to Users)",
                    "request": {
                        "method": "POST",
                        "header": [
                            {"key": "Authorization", "value": "Bearer {{admin_access_token}}"},
                            {"key": "Content-Type", "value": "application/json"}
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"type\": \"vectra_to_users\",\n    \"recipients\": [\"all\"],\n    \"subject\": \"Platform Announcement\",\n    \"body\": \"Important announcement from Vectra\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/admin/notifications/send",
                            "host": ["{{base_url}}"],
                            "path": ["api", "v1", "admin", "notifications", "send"]
                        },
                        "description": "Send notification to all platform users (Platform Admin only)."
                    },
                    "response": []
                }
            ],
            "description": "Endpoints pour Platform Admin (Vectra Owner)"
        }
    ],
    "variable": [
        {
            "key": "base_url",
            "value": "http://localhost:8000",
            "type": "string"
        },
        {
            "key": "admin_access_token",
            "value": "",
            "type": "string",
            "description": "Access token for Platform Admin user"
        },
        {
            "key": "target_user_id",
            "value": "",
            "type": "string",
            "description": "ID of target user for role updates/removals"
        },
        {
            "key": "campaign_id",
            "value": "",
            "type": "string",
            "description": "ID of campaign for filtering leads/emails"
        },
        {
            "key": "lead_id",
            "value": "",
            "type": "string",
            "description": "ID of lead for lead operations"
        },
        {
            "key": "email_id",
            "value": "",
            "type": "string",
            "description": "ID of email for email operations"
        }
    ]
}
